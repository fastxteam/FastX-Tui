# 任务管理

## 概述

FastX-Tui 实现了一个高效的异步任务队列系统，用于处理耗时操作，确保用户界面保持响应。任务管理系统支持非阻塞执行、任务状态跟踪、结果查看和任务取消。

## 核心概念

### 1. 任务

任务是指需要执行的操作，包括：
- 命令执行
- 文件操作
- 网络请求
- 插件操作
- 系统命令

### 2. 任务状态

每个任务都有一个状态：

| 状态 | 描述 |
|------|------|
| `PENDING` | 任务已创建，等待执行 |
| `RUNNING` | 任务正在执行 |
| `COMPLETED` | 任务执行成功 |
| `FAILED` | 任务执行失败 |
| `CANCELLED` | 任务被取消 |

### 3. 任务队列

任务队列是一个先进先出的队列，用于存储等待执行的任务。

### 4. 工作线程

工作线程负责从任务队列中取出任务并执行。FastX-Tui 会根据系统资源自动调整工作线程数量。

## 查看任务列表

您可以通过以下方式查看任务列表：

1. 按 `T` 键快速打开任务列表
2. 或从主菜单选择「任务管理」

任务列表显示所有任务的：
- 任务 ID
- 任务名称
- 任务状态
- 开始时间
- 结束时间（如果已完成）
- 结果预览

## 任务操作

### 1. 查看任务详情

1. 在任务列表中使用方向键选择任务
2. 按 `Enter` 键查看任务详情

任务详情包括：
- 任务完整信息
- 执行日志
- 完整结果

### 2. 取消任务

1. 在任务列表中使用方向键选择正在执行的任务
2. 按 `Delete` 键取消任务

### 3. 删除任务

1. 在任务列表中使用方向键选择已完成或已失败的任务
2. 按 `Delete` 键删除任务

### 4. 清除所有任务

1. 在任务列表中按 `Ctrl+L` 键
2. 确认清除所有任务

## 异步任务配置

您可以配置异步任务系统的行为：

1. 按 `S` 键打开设置界面
2. 选择「高级设置」
3. 调整以下设置：

| 设置项 | 描述 |
|-------|------|
| 使用异步任务 | 启用/禁用异步任务执行 |
| 任务队列大小 | 设置任务队列的最大容量 |
| 工作线程数 | 设置工作线程数量 |

## 开发中的异步任务

### 启用异步任务

在插件开发中，您可以通过以下方式启用异步任务：

1. 在 `pyproject.toml` 中添加依赖：
   ```toml
   [project]
dependencies = [
    "fastx-tui[async]",
]
   ```

2. 在插件代码中使用异步任务：
   ```python
   from core.task_manager import TaskManager
   
   task_manager = TaskManager()
   
   # 创建并执行异步任务
   task_id = task_manager.create_task(
       name="示例任务",
       command="echo 'Hello, World!'",
       command_type="shell"
   )
   
   # 获取任务状态
   status = task_manager.get_task_status(task_id)
   
   # 获取任务结果
   result = task_manager.get_task_result(task_id)
   ```

### 任务回调

您可以为任务添加回调函数，在任务完成时执行：

```python
def task_callback(task_id, result, status):
    print(f"任务 {task_id} 完成，状态：{status}，结果：{result}")

task_manager.create_task(
    name="带回调的任务",
    command="echo 'Hello, Callback!'",
    command_type="shell",
    callback=task_callback
)
```

## 最佳实践

1. **使用异步任务处理耗时操作**：对于耗时超过 1 秒的操作，建议使用异步任务执行
2. **设置合理的任务队列大小**：根据系统资源和预期负载调整队列大小
3. **监控任务状态**：定期检查长时间运行的任务状态
4. **清理过期任务**：及时删除不再需要的任务，释放内存
5. **处理任务失败**：为关键任务添加失败处理逻辑

## 常见问题

### 1. 任务执行缓慢

如果任务执行缓慢，可能的原因：
- 系统资源不足
- 工作线程数量过少
- 任务队列已满
- 任务本身耗时较长

### 2. 任务执行失败

如果任务执行失败，您可以：
- 查看任务详情和执行日志
- 检查命令格式是否正确
- 检查系统资源是否充足
- 检查权限是否足够

### 3. 任务被取消但仍在执行

某些任务可能无法立即取消，例如：
- 已开始执行的系统命令
- 无法中断的网络请求
- 长时间运行的计算任务

## 下一步

- 了解 [插件开发](../plugin_development/guide.md)
- 查看 [配置参考](../configuration/options.md)
- 学习 [开发指南](../development/environment.md)
