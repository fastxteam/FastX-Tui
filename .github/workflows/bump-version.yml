name: Bump Version

on:
  push:
    branches:
      - main

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install uv
        run: python -m pip install uv
        
      - name: Sync dependencies with uv
        run: uv sync
        
      - name: Install additional dependencies
        run: uv add toml

      - name: Install directory dependencies
        run: |
          pip install toml
          pip install json
          pip install os
          pip install subprocess

      - name: Bump version
        id: bump_version
        run: |
          import toml
          import json
          import os
          import subprocess
          
          # Read current version from pyproject.toml
          with open('pyproject.toml', 'r') as f:
              data = toml.load(f)
          
          current_version = data['project']['version']
          print(f"Current version: {current_version}")
          
          # Get the latest tag from remote to avoid conflicts
          try:
              subprocess.run(['git', 'fetch', '--tags'], check=True)
              latest_tag = subprocess.check_output(['git', 'describe', '--tags', '--abbrev=0'], text=True).strip()
              if latest_tag.startswith('v'):
                  latest_tag = latest_tag[1:]
              print(f"Latest remote tag version: {latest_tag}")
              
              # Use the latest tag version if it's newer than the current version
              if latest_tag > current_version:
                  print(f"Remote tag version {latest_tag} is newer than current version {current_version}")
                  new_version = latest_tag
              else:
                  # Split version into parts and increment patch version
                  major, minor, patch = map(int, current_version.split('.'))
                  patch += 1
                  new_version = f"{major}.{minor}.{patch}"
                  print(f"New version: {new_version}")
          except Exception as e:
              print(f"Error fetching remote tags: {e}")
              # Fallback to local version increment
              major, minor, patch = map(int, current_version.split('.'))
              patch += 1
              new_version = f"{major}.{minor}.{patch}"
              print(f"Fallback to new version: {new_version}")
          
          # Update pyproject.toml
          data['project']['version'] = new_version
          with open('pyproject.toml', 'w') as f:
              toml.dump(data, f)
          
          # Update version in all language files
          locales_dir = 'locales'
          if os.path.exists(locales_dir):
              for file_name in os.listdir(locales_dir):
                  if file_name.endswith('.json'):
                      file_path = os.path.join(locales_dir, file_name)
                      with open(file_path, 'r', encoding='utf-8') as f:
                          lang_data = json.load(f)
                      
                      if 'app' in lang_data and 'version' in lang_data['app']:
                          lang_data['app']['version'] = f"v{new_version}"
                          with open(file_path, 'w', encoding='utf-8') as f:
                              json.dump(lang_data, f, indent=2, ensure_ascii=False, sort_keys=False)
                          print(f"Updated version in {file_path}")
          
          # Output new version for next steps
          print(f"::set-output name=new_version::{new_version}")
        shell: python
      
      - name: Commit and push version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "Bump version to v${{ steps.bump_version.outputs.new_version }}"
          git push origin main
      
      - name: Create tag
        id: create_tag
        run: |
          tag_name="v${{ steps.bump_version.outputs.new_version }}"
          git tag $tag_name
          git push origin $tag_name
          echo "::set-output name=tag_name::$tag_name"
      
      - name: Print results
        run: |
          echo "New version: ${{ steps.bump_version.outputs.new_version }}"
          echo "New tag: ${{ steps.create_tag.outputs.tag_name }}"
